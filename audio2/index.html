<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cat vs Dog Audio Classifier</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
  </style>
  <link rel="icon" href="data:,">
</head>
<body>
  <h1>Cat vs Dog Audio Classifier v7</h1>
  <input type="file" id="audio-upload" accept=".wav" />
  <p id="status">Please upload a .wav file</p>
  <p id="prediction"></p>

  <script type="module">
    window.addEventListener('DOMContentLoaded', async () => {
      const MODEL_URL = './tfjs_model_audio/model.json';
      const classNames = ['dog', 'cat'];

      // Resample audio to 16kHz mono using Web Audio API
      async function resampleTo16kHz(file) {
        const originalCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        const decoded = await originalCtx.decodeAudioData(arrayBuffer);

        if (decoded.sampleRate === 16000) {
          return decoded.getChannelData(0);
        }

        const offlineCtx = new OfflineAudioContext(1, decoded.duration * 16000, 16000);
        const source = offlineCtx.createBufferSource();
        source.buffer = decoded;
        source.connect(offlineCtx.destination);
        source.start();
        const rendered = await offlineCtx.startRendering();
        return rendered.getChannelData(0);
      }

      document.getElementById('audio-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('status').innerText = 'Processing...';

        try {
          const waveform = await resampleTo16kHz(file);
          console.log(waveform.slice(0, 10)); // log first 10 values
          console.log(typeof waveform[0]);    // check type of values
          const audioTensor = tf.tensor(waveform); // 1D tensor
          const model = await tf.loadGraphModel(MODEL_URL);

          // Determine correct input name
          const inputName = model.inputs[0].name.split(':')[0]; // e.g., 'serving_default_audio'

          const result = model.execute({ [inputName]: audioTensor });
          const probs = await result.data();

          const predictedIndex = probs.indexOf(Math.max(...probs));
          const prediction = classNames[predictedIndex];

          document.getElementById('prediction').innerText =
            `Prediction: ${prediction} (dog: ${probs[0].toFixed(3)}, cat: ${probs[1].toFixed(3)})`;
          document.getElementById('status').innerText = 'Done';
        } catch (err) {
          console.error(err);
          document.getElementById('status').innerText = 'Error processing audio.';
        }
      });
    });
  </script>
</body>
</html>
