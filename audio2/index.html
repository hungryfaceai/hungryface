<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cat vs Dog Audio Classifier</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
  </style>
  <link rel="icon" href="data:,">
</head>
<body>
  <h1>Cat vs Dog Audio Classifier v11</h1>
  <input type="file" id="audio-upload" accept=".wav" />
  <p id="status">Please upload a .wav file</p>
  <p id="prediction"></p>

  <script type="module">
    window.addEventListener('DOMContentLoaded', async () => {
      const MODEL_URL = './tfjs_model_audio/model.json';
      const classNames = ['dog', 'cat'];

      async function resampleTo16kHz(file) {
        const originalCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        const decoded = await originalCtx.decodeAudioData(arrayBuffer);

        if (decoded.sampleRate === 16000) {
          return decoded.getChannelData(0);
        }

        const offlineCtx = new OfflineAudioContext(1, decoded.duration * 16000, 16000);
        const source = offlineCtx.createBufferSource();
        source.buffer = decoded;
        source.connect(offlineCtx.destination);
        source.start();
        const rendered = await offlineCtx.startRendering();
        return rendered.getChannelData(0);
      }

      document.getElementById('audio-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('status').innerText = 'Processing...';

        try {
          const waveform = await resampleTo16kHz(file);
          const audioTensor = tf.tensor(waveform); // 1D tensor

          const model = await tf.loadGraphModel(MODEL_URL);
          const inputName = model.inputs[0].name.split(':')[0];

          console.log('‚úÖ Model inputs:', model.inputs);
          console.log('‚úÖ Running model.execute with input:', inputName, audioTensor.shape);

          const result = model.execute({ [inputName]: audioTensor });

          console.log('‚úÖ Raw model output:', result);

          let probs, labelId;

          if (Array.isArray(result)) {
            console.log('‚ö†Ô∏è Model returned array of tensors');
            result.forEach((t, i) => console.log(`Tensor[${i}] shape:`, t.shape));
            probs = await result[0].data();
            labelId = (await result[1].data())[0];
          } else if (result instanceof tf.Tensor) {
            console.log('‚ö†Ô∏è Model returned single tensor:', result.shape);
            if (result.size === 0) throw new Error("Model output tensor is empty.");
            probs = await result.data();
            labelId = probs.indexOf(Math.max(...probs));
          } else if (typeof result === 'object') {
            console.log('‚ö†Ô∏è Model returned object:', Object.keys(result));
            const probsTensor = result['probs'];
            const labelTensor = result['label_id'];

            if (!probsTensor || probsTensor.size === 0) throw new Error("Missing or empty 'probs'");
            if (!labelTensor || labelTensor.size === 0) throw new Error("Missing or empty 'label_id'");

            probs = await probsTensor.data();
            labelId = (await labelTensor.data())[0];
          } else {
            throw new Error("‚ùå Unrecognized model output format");
          }

          console.log('‚úÖ Probabilities:', probs);
          console.log('‚úÖ Predicted label ID:', labelId);

          const prediction = classNames[labelId] ?? `Unknown (${labelId})`;

          document.getElementById('prediction').innerText =
            `Prediction: ${prediction} (dog: ${probs[0]?.toFixed(3)}, cat: ${probs[1]?.toFixed(3)})`;
          document.getElementById('status').innerText = 'Done';

        } catch (err) {
          console.error('üö® Error:', err);
          document.getElementById('status').innerText = 'Error processing audio.';
        }
      });
    });
  </script>
</body>
</html>
