<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cat vs Dog Audio Classifier</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
  </style>
  <link rel="icon" href="data:,">
</head>
<body>
  <h1>Cat vs Dog Audio Classifier v17</h1>
  <input type="file" id="audio-upload" accept=".wav" />
  <p id="status">Please upload a .wav file</p>
  <p id="prediction"></p>

  <script type="module">
    console.log("üì¶ Script loaded");

    window.addEventListener('DOMContentLoaded', async () => {
      console.log("üöÄ DOM fully loaded");

      const MODEL_URL = './model_tfjs_audio/model.json';
      const classNames = ['dog', 'cat'];

      async function resampleTo16kHz(file) {
        console.log("üéß Resampling audio...");
        const originalCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        const decoded = await originalCtx.decodeAudioData(arrayBuffer);

        if (decoded.sampleRate === 16000) {
          return decoded.getChannelData(0);
        }

        const offlineCtx = new OfflineAudioContext(1, decoded.duration * 16000, 16000);
        const source = offlineCtx.createBufferSource();
        source.buffer = decoded;
        source.connect(offlineCtx.destination);
        source.start();
        const rendered = await offlineCtx.startRendering();
        return rendered.getChannelData(0);
      }

      const input = document.getElementById('audio-upload');
      if (!input) {
        console.error("‚ùå Could not find #audio-upload input element");
        return;
      }

      input.addEventListener('change', async (e) => {
        console.log("üìÇ File input changed");

        const file = e.target.files?.[0];
        if (!file) {
          console.warn("‚ö†Ô∏è No file selected");
          return;
        }

        console.log("üìÑ File selected:", file.name, file.type);
        document.getElementById('status').innerText = 'Processing...';

        try {
          const waveform = await resampleTo16kHz(file);
          console.log("‚úÖ Got waveform:", waveform.length, "samples");
          const audioTensor = tf.tensor(waveform); // 1D tensor
          console.log("üìä Created tensor:", audioTensor.shape);

          const model = await tf.loadGraphModel(MODEL_URL);
          console.log("‚úÖ Model loaded");

          const inputName = model.inputs[0].name.split(':')[0];
          console.log("üì• Input name:", inputName);

          const result = model.execute({ [inputName]: audioTensor });
          console.log("üì§ Model.execute() returned:", result);

          let probs;

          if (Array.isArray(result)) {
            console.log('üì¶ Result is an array of tensors');
            result.forEach((t, i) => console.log(`  - Tensor[${i}] shape:`, t.shape));
            probs = await result[0].data(); // assuming first tensor is probs
          } else if (result instanceof tf.Tensor) {
            console.log('üì¶ Result is a single tensor');
            if (result.size === 0) throw new Error("Model output tensor is empty.");
            probs = await result.data();
          } else if (typeof result === 'object') {
            console.log('üì¶ Result is an object:', Object.keys(result));
            const probsTensor = result['probs'];
            if (!probsTensor || probsTensor.size === 0) throw new Error("Missing or empty 'probs'");
            probs = await probsTensor.data();
          } else {
            throw new Error("‚ùå Unrecognized model output format");
          }

          const labelId = probs.indexOf(Math.max(...probs));
          const prediction = classNames[labelId] ?? `Unknown (${labelId})`;

          console.log('‚úÖ Probabilities:', probs);
          console.log('‚úÖ Predicted label ID:', labelId);

          document.getElementById('prediction').innerText =
            `Prediction: ${prediction} (dog: ${probs[0]?.toFixed(3)}, cat: ${probs[1]?.toFixed(3)})`;
          document.getElementById('status').innerText = 'Done';

        } catch (err) {
          console.error("üö® Error during classification:", err);
          document.getElementById('status').innerText = 'Error processing audio.';
        }
      });
    });
  </script>
</body>
</html>
