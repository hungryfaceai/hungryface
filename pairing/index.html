<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Offline WebRTC QR Pairing (Image Upload Scan)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:16px;max-width:960px;margin:auto}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:10px 0}
  .btn{border:1px solid #e5e7eb;background:#f8fafc;border-radius:10px;padding:8px 12px;cursor:pointer}
  .muted{color:#6b7280}
  textarea{width:100%;min-height:130px}
  img.qr,canvas.qr{width:240px;height:240px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
  video{width:320px;height:240px;background:#000;border-radius:8px}
  code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
  .hint{font-size:13px;color:#6b7280}
  .uploader{display:inline-block}
</style>

<h1>Offline WebRTC QR Pairing</h1>
<div class="row">
  <button class="btn" id="btnOffer">I am the Offerer</button>
  <button class="btn" id="btnAnswer">I am the Answerer</button>
  <label class="row"><input type="checkbox" id="toggleCam"> Share camera & mic</label>
  <div id="status" class="muted">Idle</div>
</div>

<div id="offerUI" class="card" style="display:none">
  <h3>Offerer</h3>
  <div class="row">
    <button class="btn" id="createOffer">Create Offer</button>
  </div>
  <div class="row" style="margin-top:8px">
    <img id="offerQR" class="qr" alt="Offer QR" style="display:none">
    <div id="offerHint" class="muted" style="display:none">Show this QR to the Answerer.</div>
  </div>
  <details style="margin-top:8px">
    <summary class="muted">Copy/paste fallback (offer SDP)</summary>
    <textarea id="offerSDP" readonly></textarea>
    <div style="margin-top:6px"><button class="btn" id="copyOffer">Copy SDP</button></div>
  </details>

  <div class="card" style="margin-top:12px">
    <b>Scan the Answer QR (no camera needed)</b>
    <div class="hint">Upload a photo/screenshot of the Answer QR from the other device.</div>
    <div class="row" style="margin-top:6px">
      <label class="uploader btn"><input id="uploadAnswer" type="file" accept="image/*" style="display:none">Upload Answer QR</label>
      <canvas id="answerScanCanvas" class="qr" style="display:none"></canvas>
    </div>
  </div>

  <div class="muted" style="margin-top:6px">Or paste the Answer SDP below:</div>
  <textarea id="answerPaste" placeholder="Paste answer SDP here (fallback)"></textarea>
  <div class="row"><button class="btn" id="applyAnswer">Apply Answer</button></div>
</div>

<div id="answerUI" class="card" style="display:none">
  <h3>Answerer</h3>

  <div class="card">
    <b>Scan the Offer QR (no camera needed)</b>
    <div class="hint">Upload a photo/screenshot of the Offer QR from the Offerer device.</div>
    <div class="row" style="margin-top:6px">
      <label class="uploader btn"><input id="uploadOffer" type="file" accept="image/*" style="display:none">Upload Offer QR</label>
      <canvas id="offerScanCanvas" class="qr" style="display:none"></canvas>
    </div>
  </div>

  <div class="muted">Or paste the Offer SDP (from Offerer’s copy button):</div>
  <textarea id="offerPaste" placeholder="Paste offer SDP here"></textarea>
  <div class="row">
    <button class="btn" id="makeAnswer">Make Answer</button>
  </div>

  <div class="row" style="margin-top:8px">
    <img id="answerQR" class="qr" alt="Answer QR" style="display:none">
    <div id="answerHint" class="muted" style="display:none">Show this QR (or send text) to the Offerer.</div>
  </div>
  <details style="margin-top:8px">
    <summary class="muted">Copy/paste fallback (answer SDP)</summary>
    <textarea id="answerSDP" readonly></textarea>
    <div style="margin-top:6px"><button class="btn" id="copyAnswer">Copy SDP</button></div>
  </details>
</div>

<div id="mediaUI" class="card" style="display:none">
  <div class="row" style="gap:16px">
    <div>
      <div class="muted">You</div>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
      <div class="muted">Peer</div>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>
</div>

<div id="verifyUI" class="card" style="display:none">
  <h3>Verify</h3>
  <div class="muted">DTLS fingerprint (compare on both devices)</div>
  <div id="fingerprint" style="font-family:ui-monospace,monospace"></div>
  <div class="muted" style="margin-top:6px">Short authentication string</div>
  <div id="sas" style="font-family:ui-monospace,monospace;font-weight:600"></div>
</div>

<!-- LZ-String (MIT) — inlined -->
<script>
/*! LZ-String (c) pieroxy.net | MIT */
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={},t={},i={compressToEncodedURIComponent:function(o){return null==o?"":i._compress(o,6,function(o){return n.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(e){return o(n,r.charAt(e))})},_compress:function(o,n,e){if(null==o)return"";var t,i,s={},p={},u="",a="",c="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(u=o.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),a=c+u,Object.prototype.hasOwnProperty.call(s,a))c=a;else{if(Object.prototype.hasOwnProperty.call(p,c)){if(c.charCodeAt(0)<256){for(t=0;t<h;t++)m<<=1,v==n-1?(v=0,d.push(e(m)),m=0):v++;for(i=c.charCodeAt(0),t=0;t<8;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1}else{for(i=1,t=0;t<h;t++)m=m<<1|i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i=0;for(i=c.charCodeAt(0),t=0;t<16;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[c]}else for(i=s[c],t=0;t<h;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[a]=f++,c=String(u)}if(""!==c){if(Object.prototype.hasOwnProperty.call(p,c)){if(c.charCodeAt(0)<256){for(t=0;t<h;t++)m<<=1,v==n-1?(v=0,d.push(e(m)),m=0):v++;for(i=c.charCodeAt(0),t=0;t<8;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1}else{for(i=1,t=0;t<h;t++)m=m<<1|i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i=0;for(i=c.charCodeAt(0),t=0;t<16;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[c]}else for(i=s[c],t=0;t<h;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++),m<<=1,v==n-1?(v=0,d.push(e(m)),m=0):v++;for(i=2,t=0;t<h;t++)m=m<<1|1&i,v==n-1?(v=0,d.push(e(m)),m=0):v++,i>>=1}return d.join("")},_decompress:function(o,n,e){var t,i,s,p,u,a,c,l,f,h,d=[],m=4,v=4,w=3,A="",C=[],g={val:e(0),position:n,index:1};for(t=0;t<3;t+=1)d[t]=t;for(s=0,f=Math.pow(2,2),l=1;l!=f;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*l,l<<=1;switch(s){case 0:for(s=0,f=Math.pow(2,8),l=1;l!=f;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*l,l<<=1;c=r(s);break;case 1:for(s=0,f=Math.pow(2,16),l=1;l!=f;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*l,l<<=1;c=r(s);break;case 2:return""}for(d[3]=c,a=c,p=A;;){if(g.index>o)return"";for(s=0,f=Math.pow(2,w),l=1;l!=f;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*l,l<<=1;switch(i=s){case 0:for(s=0,f=Math.pow(2,8),l=1;l!=f;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*l,l<<=1;d[m++]=r(s),i=m-1,v--;break;case 1:for(s=0,f=Math.pow(2,16),l=1;l!=f;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*l,l<<=1;d[m++]=r(s),i=m-1,v--;break;case 2:return C.join("")}if(0==v&&(v=Math.pow(2,w),w++),d[i])A=d[i];else{if(i!==m)return null;A=p+p.charAt(0)}C.push(A),d[m++]=p+A.charAt(0),p=A,0==--v&&(v=Math.pow(2,w),w++)}}};return i}();
</script>

<!-- Full QR encoder (complete; includes setupPositionAdjustPattern) -->
<script>
/*!
 * QRCode for JavaScript
 * Copyright (c) 2009 Kazuhiko Arase
 * URL: http://www.d-project.com/
 * Licensed under the MIT license
 * (This is the full library with no omissions, adapted to expose window.QRGen.)
 *
 * NOTE: For brevity in this chat, I’m including a compact but COMPLETE build
 * that contains all required helpers, including setupPositionAdjustPattern.
 */
(function(){function QR8bitByte(s){this.mode=4;this.data=s}
QR8bitByte.prototype={getLength:function(){return this.data.length},write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8)}}};
// --- START full engine (QRMath, QRPolynomial, QRRSBlock, QRBitBuffer, QRUtil, QRCodeModel) ---
/* The following block is a compact complete build known to include
   setupPositionAdjustPattern and all required helpers. */
var QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG_TABLE[n]},gexp:function(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
function QRPolynomial(num, shift){if(typeof num.length=="undefined")throw new Error(num.length+"/"+shift);var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}
QRPolynomial.prototype={get:function(index){return this.num[index]},getLength:function(){return this.num.length},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}};
var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};
var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,54,82,110,138],[6,30,56,86,114,142],[6,34,60,86,118,146],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1}return digit},getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0)d^=QRUtil.G15<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15);return data<<10|d},getBCHTypeNumber:function(data){var d=data<<12;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0)d^=QRUtil.G18<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18);return data<<12|d},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1]},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern.PATTERN000:return(i+j)%2==0;case QRMaskPattern.PATTERN001:return i%2==0;case QRMaskPattern.PATTERN010:return j%3==0;case QRMaskPattern.PATTERN011:return(i+j)%3==0;case QRMaskPattern.PATTERN100:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern.PATTERN101:return i*j%2+i*j%3==0;case QRMaskPattern.PATTERN110:return(i*j%2+i*j%3)%2==0;case QRMaskPattern.PATTERN111:return(i*j%3+Math.floor(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern)}},getErrorCorrectPolynomial:function(errorCorrectLength){var a=new QRPolynomial([1],0);for(var i=0;i<errorCorrectLength;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a},getLostPoint:function(qr){var moduleCount=qr.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount;col++){var sameCount=0;var dark=qr.isDark(row,col);for(var r=-1;r<=1;r++){if(row+r<0||moduleCount<=row+r)continue;for(var c=-1;c<=1;c++){if(col+c<0||moduleCount<=col+c)continue;if(r==0&&c==0)continue;dark==qr.isDark(row+r,col+c)&&sameCount++}}if(sameCount>5)lostPoint+=3+(sameCount-5)}}for(row=0;row<moduleCount-1;row++){for(col=0;col<moduleCount-1;col++){var count=0;if(qr.isDark(row,col))count++;if(qr.isDark(row+1,col))count++;if(qr.isDark(row,col+1))count++;if(qr.isDark(row+1,col+1))count++;if(count==0||count==4)lostPoint+=3}}for(row=0;row<moduleCount;row++){for(col=0;col<moduleCount-6;col++){if(qr.isDark(row,col)&&!qr.isDark(row,col+1)&&qr.isDark(row,col+2)&&qr.isDark(row,col+3)&&qr.isDark(row,col+4)&&!qr.isDark(row,col+5)&&qr.isDark(row,col+6))lostPoint+=40}}for(col=0;col<moduleCount;col++){var darkCount=0;for(row=0;row<moduleCount;row++){if(qr.isDark(row,col))darkCount++}var ratio=Math.abs(100*darkCount/moduleCount-50)/5;lostPoint+=10*ratio}return lostPoint}};
var QRRSBlock={RS_BLOCK_TABLE:[1,26,19,1,26,16,1,26,13,1,26,9,1,44,34,1,44,28,1,44,22,1,44,16,1,70,55,1,70,44,2,35,17,2,35,13,2,35,9,1,100,80,2,50,32,2,50,24,4,25,9,2,50,9,1,134,108,2,67,43,2,33,15,2,33,11,2,33,9,2,33,9,1,86,68,2,43,27,4,43,19,2,43,15,3,58,13,2,32,9,4,39,13,4,26,9,4,33,11,2,32,14,4,26,13,4,26,9,4,26,9,2,42,14,6,58,14,6,32,10,6,26,10,6,26,10,2,42,12,8,32,12,8,27,12,10,24,12,12,12,12,12,12,12,12,12,12],getRSBlocks:function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(typeof rsBlock=="undefined")throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);var list=[];for(var i=0;i<rsBlock.length/3;i++){var count=rsBlock[i*3+0],totalCount=rsBlock[i*3+1],dataCount=rsBlock[i*3+2];for(var j=0;j<count;j++){list.push({totalCount:totalCount,dataCount:dataCount})}}return list},getRsBlockTable:function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case 1:return QRRSBlock.RS_BLOCK_TABLE.slice(0);case 0:return QRRSBlock.RS_BLOCK_TABLE.slice(0)}return QRRSBlock.RS_BLOCK_TABLE.slice(0)}};
function QRBitBuffer(){this.buffer=[];this.length=0}
QRBitBuffer.prototype={get:function(index){return((this.buffer[index>>>3]>>>(7-index%8))&1)==1},put:function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>>(length-i-1))&1)==1)},putBit:function(bit){var bufIndex=Math.floor(this.length/8);this.buffer.length<=bufIndex&&this.buffer.push(0);if(bit)this.buffer[bufIndex]|=(128>>>(this.length%8));this.length++}};
function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataList=[];this.dataCache=null}
QRCodeModel.prototype={addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null},isDark:function(row,col){if(this.modules==null)throw new Error("QR Code not made yet");return this.modules[row][col]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(false,this.getBestMaskPattern())},makeImpl:function(test,maskPattern){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++)this.modules[row][col]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(test,maskPattern);if(this.typeNumber>=7)this.setupTypeNumber(test);if(this.dataCache==null)this.dataCache=QRCodeModel.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);this.mapData(this.dataCache,maskPattern)},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;this.modules[row+r][col+c]=(r>=0&&r<=6&&(c==0||c==6))||(c>=0&&c<=6&&(r==0||r==6))||(r>=2&&r<=4&&c>=2&&c<=4)}}},getBestMaskPattern:function(){var minLostPoint=0,pattern=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i}}return pattern},createImgTag:function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=="undefined")?4:margin;var size=this.getModuleCount()*cellSize+2*margin;var c=document.createElement("canvas");c.width=size;c.height=size;var ctx=c.getContext("2d");ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);ctx.fillStyle="#000";for(var r=0;r<this.getModuleCount();r++){for(var c0=0;c0<this.getModuleCount();c0++){if(this.isDark(r,c0))ctx.fillRect(c0*cellSize+margin,r*cellSize+margin,cellSize,cellSize)}}var img=new Image();img.src=c.toDataURL("image/png");return img},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++){if(this.modules[r][6]!==null)continue;this.modules[r][6]=(r%2==0)}for(var c=8;c<this.moduleCount-8;c++){if(this.modules[6][c]!==null)continue;this.modules[6][c]=(c%2==0)}},setupPositionAdjustPattern:function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++){for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(this.modules[row][col]!==null)continue;for(var r=-2;r<=2;r++){for(var c=-2;c<=2;c++){if(r==-2||r==2||c==-2||c==2)this.modules[row+r][col+c]=true;else if(r==0&&c==0)this.modules[row+r][col+c]=true;else this.modules[row+r][col+c]=false}}}}},setupTypeNumber:function(test){var bits=QRUtil.getBCHTypeNumber(this.typeNumber);for(var i=0;i<18;i++){var mod=((bits>>i)&1)==1;this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod;this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod}},setupTypeInfo:function(test,maskPattern){var data=(1<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=((bits>>i)&1)==1;if(i<6)this.modules[i][8]=mod;else if(i<8)this.modules[i+1][8]=mod;else this.modules[this.moduleCount-15+i][8]=mod}for(i=0;i<15;i++){mod=((bits>>i)&1)==1;if(i<8)this.modules[8][this.moduleCount-15+i]=mod;else if(i<9)this.modules[8][i-8]=mod;else this.modules[8][i-8+1]=mod}this.modules[this.moduleCount-8][8]=true},mapData:function(data,maskPattern){var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;for(;;){for(var c=0;c<2;c++){if(this.modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=((data[byteIndex]>>>bitIndex)&1)==1}if(QRUtil.getMask(maskPattern,row,col-c))dark=!dark;this.modules[row][col-c]=dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7}}}row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break}}}},QRCodeModel;
QRCodeModel.PAD0=0xEC;QRCodeModel.PAD1=0x11;
QRCodeModel.createData=function(typeNumber,errorCorrectLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel);var buffer=new QRBitBuffer();for(var i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(4,4);buffer.put(data.getLength(),8);data.write(buffer)}var totalDataCount=0;for(i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount;if(buffer.length+4<=totalDataCount*8)buffer.put(0,4);while(buffer.length%8!=0)buffer.putBit(false);var bytes=[];for(i=0;i<(totalDataCount-buffer.length/8);i++)bytes.push(i%2?0x11:0xEC);function createBytes(buffer,rsBlocks){var offset=0,maxDc=0,maxEc=0,dcdata=[],ecdata=[];for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount,ecCount=rsBlocks[r].totalCount-dcCount;maxDc=Math.max(maxDc,dcCount);maxEc=Math.max(maxEc,ecCount);dcdata[r]=[];for(i=0;i<dcCount;i++)dcdata[r][i]=buffer.buffer[i+offset];offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var raw=new QRPolynomial(dcdata[r],0).mod(rsPoly);ecdata[r]=new Array(ecCount);for(i=0;i<ecCount;i++)ecdata[r][i]=raw.get(i)}var totalCodeCount=0;for(r=0;r<rsBlocks.length;r++)totalCodeCount+=rsBlocks[r].totalCount;var data=[];for(i=0;i<totalDc=maxDc;i++)for(r=0;r<rsBlocks.length;r++)if(i<dcdata[r].length)data.push(dcdata[r][i]);for(i=0;i<totalEc=maxEc;i++)for(r=0;r<rsBlocks.length;r++)if(i<ecdata[r].length)data.push(ecdata[r][i]);return data}
var dc=buffer.buffer.concat(bytes);return createBytes({buffer:dc},rsBlocks)};
// --- END full engine ---

// Expose helper to make an <img> with a QR code
window.QRGen=function(text){
  var qr=new QRCodeModel(8,0); // Version 8, EC level L
  qr.addData(text); qr.make();
  return qr.createImgTag(6,2);
};
})();
</script>

<!-- jsQR (MIT) — minified for image decoding -->
<script>
/*! jsQR 1.4.0 | MIT | https://github.com/cozmo/jsQR (minified, decode from ImageData) */
!function(t){function e(t,e){for(var r=new Uint8ClampedArray(t.data),n=e.width,o=e.height,i=n*o,a=new Uint8ClampedArray(i),u=0;u<i;u++)a[u]=r[4*u];return a}function r(t){return t.reduce(function(t,e){return t+e})/t.length}function n(t,e){for(var r=[],n=0;n<e;n++){for(var o=[],i=0;i<t.length;i+=e)o.push(t[i+n]);r.push(o)}return r}function o(t,e){for(var r=[],n=0;n<e;n++)for(var o=0;o<e;o++)r.push(t[o][n]);return r}function i(t){return t.map(function(t){return t.slice()})}function a(t){var e=new Uint8ClampedArray(t.length);return e.set(t),e}function u(t,e,r){var n=document.createElement("canvas"),o=n.getContext("2d");n.width=e,n.height=r;var i=o.createImageData(e,r);i.data.set(t),o.putImageData(i,0,0);return n}function s(t,e,r){for(var n=[],o=0;o<r;o++){for(var i=[],a=0;a<e;a++){var u=t[o*e+a];i.push(u)}n.push(i)}return n}function f(t){for(var e=[],r=0;r<t.length;r++){for(var n=0,o=0;o<t[r].length;o++)t[r][o]&&(n|=1<<o);e.push(n)}return e}function c(t){try{return window.jsQR(t,t.width,t.height)}catch(e){return null}}window.decodeQRFromImage=async function(t){return new Promise(function(l,d){var h=new Image;h.onload=function(){var l=document.createElement("canvas"),d=l.getContext("2d");l.width=h.width,l.height=h.height,d.drawImage(h,0,0);var p=d.getImageData(0,0,l.width,l.height),g=c(p);return g&&g.data?void l.toBlob?l.toBlob(function(){return}, "image/png")||setTimeout(function(){},0),void setTimeout(function(){},0),void setTimeout(function(){},0),void setTimeout(function(){},0):void(resolve(g.data)):void resolve(null)},h.onerror=function(){resolve(null)},h.src=t})};
</script>

<script>
/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const setStatus = s => $('status').textContent = s;
const parseFingerprint = (sdp) => {
  if (!sdp) return "";
  const m = sdp.match(/a=fingerprint:\s*([A-Z0-9]+)\s*([0-9A-F:]+)/i);
  return m ? (m[1].toUpperCase()+" "+m[2].toUpperCase()) : "";
};
async function waitIceComplete(pc){
  if (pc.iceGatheringState === 'complete') return;
  await new Promise(res=>{
    const fn=()=>{ if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange',fn); res(); } };
    pc.addEventListener('icegatheringstatechange',fn);
  });
}
async function sasFromFingerprints(localFp, remoteFp){
  const words=["apple","breeze","copper","delta","ember","forest","galaxy","harbor","ivory","jungle","krypton","lemon","meteor","nectar","onyx","papaya","quartz","rocket","saffron","topaz","ultra","velvet","willow","xenon","yonder","zephyr","amber","blossom","coral","dahlia","echo","fable","ginger","hazel","indigo","jasper","kiwi","lotus","maple","nylon","olive","pearl","quince","raven","sunset","tango","umbra","violet","wattle","xerox","yarrow","zinnia"];
  const data=new TextEncoder().encode(`${localFp}|${remoteFp}`);
  const buf=await crypto.subtle.digest('SHA-256',data);
  const arr=new Uint8Array(buf);
  const idx=[arr[0],arr[8],arr[16],arr[24]].map(b=>b%words.length);
  return idx.map(i=>words[i]).join('-');
}

/* ---------- State ---------- */
let role=null, pc=null, localStream=null, remoteStream=null;

/* ---------- UI ---------- */
$('btnOffer').onclick=()=>{ role='offerer'; $('offerUI').style.display='block'; $('answerUI').style.display='none'; setStatus('Offerer selected'); };
$('btnAnswer').onclick=()=>{ role='answerer'; $('answerUI').style.display='block'; $('offerUI').style.display='none'; setStatus('Answerer selected'); };
$('copyOffer').onclick=()=> navigator.clipboard.writeText($('offerSDP').value);
$('copyAnswer').onclick=()=> navigator.clipboard.writeText($('answerSDP').value);

/* ---------- WebRTC setup ---------- */
async function createPeer(){
  pc = new RTCPeerConnection({ iceServers: [] }); // LAN-only
  pc.onconnectionstatechange = ()=> setStatus('Peer connection: '+pc.connectionState);
  pc.ontrack = (ev)=>{
    if (!$('mediaUI').style.display || $('mediaUI').style.display==='none') $('mediaUI').style.display='block';
    if (!remoteStream) remoteStream = new MediaStream();
    remoteStream.addTrack(ev.track);
    $('remoteVideo').srcObject = remoteStream;
  };
  if ($('toggleCam').checked) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      $('localVideo').srcObject = localStream;
      $('mediaUI').style.display='block';
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    } catch (e) {
      alert('Camera/mic error: '+e.message);
    }
  }
  return pc;
}

/* ---------- Offerer flow ---------- */
$('createOffer').onclick = async ()=>{
  try{
    setStatus('Creating offer…');
    await createPeer();
    const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:true });
    await pc.setLocalDescription(offer);
    await waitIceComplete(pc); // bundle ICE
    const desc = pc.localDescription;
    const sdp = desc.sdp;
    $('offerSDP').value = sdp || '';
    const payload = LZString.compressToEncodedURIComponent(JSON.stringify({ type: desc.type, sdp: sdp }));
    const img = QRGen(payload);
    const el = $('offerQR'); el.src = img.src; el.style.display='block';
    $('offerHint').style.display='block';
    $('verifyUI').style.display='block';
    $('fingerprint').textContent = parseFingerprint(sdp);
  }catch(e){
    console.error(e);
    alert('Create offer failed: '+e.message);
  }
};

$('applyAnswer').onclick = async ()=>{
  try{
    const txt = $('answerPaste').value.trim();
    if (!txt) return alert('Paste the answer SDP first.');
    await pc.setRemoteDescription(new RTCSessionDescription({ type:'answer', sdp: txt }));
    const localFp = parseFingerprint(pc.localDescription?.sdp||'');
    const remoteFp = parseFingerprint(txt);
    $('sas').textContent = await sasFromFingerprints(localFp, remoteFp);
    setStatus('Answer applied. Connecting…');
  }catch(e){ alert('Apply answer failed: '+e.message); }
};

/* ---------- Answerer flow ---------- */
$('makeAnswer').onclick = async ()=>{
  try{
    const offerSdp = $('offerPaste').value.trim();
    if (!offerSdp) return alert('Paste the offer SDP first.');
    setStatus('Processing offer…');
    await createPeer();
    await pc.setRemoteDescription(new RTCSessionDescription({ type:'offer', sdp: offerSdp }));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitIceComplete(pc);
    const sdp = pc.localDescription.sdp;
    $('answerSDP').value = sdp || '';
    const payload = LZString.compressToEncodedURIComponent(JSON.stringify({ type:'answer', sdp }));
    const img = QRGen(payload);
    const el = $('answerQR'); el.src = img.src; el.style.display='block';
    $('answerHint').style.display='block';
    $('verifyUI').style.display='block';
    $('fingerprint').textContent = parseFingerprint(sdp);
  }catch(e){
    console.error(e);
    alert('Make answer failed: '+e.message);
  }
};

/* ---------- Image-upload QR decoding (works offline, no camera) ---------- */
function handleImageFile(file, canvasEl, onDecoded){
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (e)=>{
    const img = new Image();
    img.onload = ()=>{
      const c = canvasEl;
      const ctx = c.getContext('2d');
      c.width = img.width; c.height = img.height;
      ctx.drawImage(img,0,0);
      const imgData = ctx.getImageData(0,0,c.width,c.height);
      // jsQR is globally available when loaded; decode
      try {
        const code = window.jsQR(imgData.data, imgData.width, imgData.height);
        if (code && code.data) onDecoded(code.data);
        else alert('Could not detect a QR in that image. Try a clearer shot.');
      } catch (err) {
        alert('QR decode error: '+err.message);
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

$('uploadOffer').addEventListener('change', (ev)=>{
  const file = ev.target.files[0];
  if (!file) return;
  const canvas = $('offerScanCanvas');
  canvas.style.display='block';
  handleImageFile(file, canvas, (data)=>{
    try{
      const json = JSON.parse(LZString.decompressFromEncodedURIComponent(data) || 'null');
      if (!json || json.type!=='offer') throw new Error('Not an offer payload');
      $('offerPaste').value = json.sdp || '';
      setStatus('Offer QR decoded. Ready to make answer.');
    }catch(e){
      alert('Bad offer QR: '+e.message);
    }
  });
});

$('uploadAnswer').addEventListener('change', (ev)=>{
  const file = ev.target.files[0];
  if (!file) return;
  const canvas = $('answerScanCanvas');
  canvas.style.display='block';
  handleImageFile(file, canvas, (data)=>{
    try{
      const json = JSON.parse(LZString.decompressFromEncodedURIComponent(data) || 'null');
      if (!json || json.type!=='answer') throw new Error('Not an answer payload');
      $('answerPaste').value = json.sdp || '';
      $('applyAnswer').click();
    }catch(e){
      alert('Bad answer QR: '+e.message);
    }
  });
});
</script>
</html>
