<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MFCC Inferno-Like Spectrogram</title>
  <script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    canvas {
      border: 1px solid #333;
      display: block;
      margin-top: 15px;
      background-color: black;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>🔥 MFCC Spectrogram (Inferno-Like)</h1>
  <button id="start">Start Microphone</button>
  <canvas id="mfccCanvas" width="800" height="256"></canvas>

  <script>
    const canvas = document.getElementById('mfccCanvas');
    const ctx = canvas.getContext('2d');
    const barWidth = 1;
    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;

    let x = 0;

    function resetCanvas() {
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    function infernoColor(intensity) {
      const r = Math.min(255, intensity * 4);
      const g = Math.min(255, intensity * 2);
      const b = Math.min(80, intensity * 0.4);
      return `rgb(${r}, ${g}, ${b})`;
    }

    function drawMFCCFrame(mfcc) {
      const numBands = mfcc.length;

      if (x >= canvasWidth) {
        const imageData = ctx.getImageData(barWidth, 0, canvasWidth - barWidth, canvasHeight);
        ctx.putImageData(imageData, 0, 0);
        x = canvasWidth - barWidth;
        ctx.clearRect(x, 0, barWidth, canvasHeight);
      }

      for (let i = 0; i < numBands; i++) {
        const norm = Math.min(1, Math.max(0, (mfcc[i] + 100) / 100));
        const intensity = Math.floor(norm * 255);
        const y = (i / numBands) * canvasHeight;  // ⬅️ origin='lower' style
        const color = infernoColor(intensity);
        ctx.fillStyle = color;
        ctx.fillRect(x, y, barWidth, canvasHeight / numBands);
      }

      x += barWidth;
    }

    document.getElementById('start').addEventListener('click', async () => {
      resetCanvas();

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioCtx = new AudioContext({ sampleRate: 16000 });
      const source = audioCtx.createMediaStreamSource(stream);

      const analyzer = Meyda.createMeydaAnalyzer({
        audioContext: audioCtx,
        source: source,
        bufferSize: 512,
        hopSize: 256,
        windowingFunction: 'hamming',
        featureExtractors: ['mfcc'],
        callback: (features) => {
          if (features && features.mfcc) {
            drawMFCCFrame(features.mfcc);
          }
        }
      });

      analyzer.start();
    });
  </script>
</body>
</html>
