<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Baby Cry Detector</title>

  <!-- User badge -->
  <div id="userBox" style="display:none; align-items:center; gap:.5rem; font:14px/1.3 system-ui, sans-serif;">
    <img id="userAvatar" alt="" width="28" height="28"
         style="border-radius:50%; object-fit:cover; display:none;">
    <div id="userInitials"
         style="width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center;background:#E5E7EB;color:#374151;font-weight:600;">
    </div>
    <span>Signed in as <strong id="userName">…</strong></span>
    <button id="signOut" class="ghost" style="margin-left:.5rem;">Sign out</button>
  </div>

  <!-- CSS -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Tiny data-URI favicon to avoid /favicon.ico 404 -->
  <link rel="icon" href="data:," />

  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- MediaPipe Tasks Audio (default export) -->
  <script type="module">
    import audio from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-audio@0.10.0";
    // Expose to the non-module app script
    window.MPTasksAudio = audio;
  </script>
</head>
<body>
  <header>
    <h1>Live Baby Cry Detector</h1>
    <p class="sub">Real-time mic inference</p>
  </header>

  <main>
    <section class="controls">
      <div class="row">
        <button id="btnStart" class="primary">Start</button>
        <button id="btnStop" class="ghost" disabled>Stop</button>
        <span id="status" class="status">Idle</span>
      </div>

      <div class="grid">
        <label>
          <span>SR_TARGET (Hz)</span>
          <input id="SR_TARGET" type="number" min="8000" step="1000" value="16000" />
        </label>

        <label>
          <span>FRAME_LEN_S</span>
          <input id="FRAME_LEN_S" type="number" min="0.1" step="0.01" value="0.96" />
        </label>

        <label>
          <span>HOP_S</span>
          <input id="HOP_S" type="number" min="0.01" step="0.01" value="0.48" />
        </label>

        <label>
          <span>SMOOTH_WIN</span>
          <input id="SMOOTH_WIN" type="number" min="1" step="1" value="5" />
        </label>

        <label>
          <span>THRESH</span>
          <input id="THRESH" type="number" min="0" max="1.5" step="0.01" value="0.15" />
        </label>

        <label>
          <span>PLOT_WINDOW_S</span>
          <input id="PLOT_WINDOW_S" type="number" min="5" step="1" value="60" />
        </label>
      </div>

      <details class="advanced">
        <summary>Advanced</summary>

      <!--
      <label class="wide">
        <span>YAMNet (TFLite) path</span>
        <input id="MODEL_URL" type="url"
               value="https://storage.googleapis.com/mediapipe-models/audio_classifier/yamnet/float32/1/yamnet.tflite" />
      </label>
      -->

        <label class="wide">
          <span>Include classes (comma-separated)</span>
          <textarea id="INCLUDE_CLASSES" rows="2" spellcheck="false">Baby cry, infant cry</textarea>
        </label>

        <p class="muted small">
          Separate multiple classes with semicolons or new lines.
        </p>

        <div class="grid-adv">
          <label>
            <span>ON extra (adds to THRESH)</span>
            <input id="ALERT_ON_EXTRA" type="number" step="0.01" value="0.00" />
          </label>
          <label>
            <span>OFF delta (below ON)</span>
            <input id="ALERT_OFF_DELTA" type="number" min="0" step="0.01" value="0.10" />
          </label>
          <label>
            <span>HOLD time (ms)</span>
            <input id="ALERT_HOLD_MS" type="number" min="0" step="100" value="3000" />
          </label>
        </div>
        <p class="muted small">
          The background turns red when the smoothed score crosses the <strong>ON threshold</strong> (= THRESH + ON extra),
          and stays red until it falls below <strong>OFF threshold</strong> (= ON threshold − OFF delta) and the hold time has elapsed.
        </p>
      </details>
    </section>

    <!-- Cry score chart -->
    <section class="plot">
      <canvas id="chart" height="160"></canvas>
      <div class="legend">
        <span class="key raw"></span> cry_score (raw)
        <span class="key sm"></span> smoothed (moving avg)
        <span class="key thr-on"></span> threshold (ON)
        <span class="key thr-off"></span> threshold (OFF)
      </div>
    </section>

    <!-- Power spectrum chart -->
    <section class="plot">
      <canvas id="chartSpectrum" height="160"></canvas>
      <div class="legend">
        <span class="key raw"></span> spectrum (raw)
        <span class="key sm"></span> spectrum (smoothed)
      </div>
      <div class="toggles">
        <label><input type="checkbox" id="showRawSpec" checked> Show raw spectrum</label>
        <label><input type="checkbox" id="showSmSpec" checked> Show smoothed spectrum</label>
      </div>
      <div id="peakReadout" class="peak">Peak: —</div>
    </section>
  </main>

  <footer>
    © 2025 Fishex Ltd. All rights reserved.
  </footer>

  <!-- App code (MediaPipe version) -->
  <!-- <script src="./app_mp.js" type="module"></script> THIS IS NOT PROTECTED -->

  <!-- THIS IS: -->
  <!-- Secure loader: fetch protected JS from Render only after Firebase login -->
  <!--
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  
    // 1) Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBUQDNX5ItDQsrReCUdWwwKW4YB7YGjC1I",
      authDomain: "hungryface-53740.firebaseapp.com",
      projectId: "hungryface-53740",
      storageBucket: "hungryface-53740.firebasestorage.app",
      messagingSenderId: "499156831119",
      appId: "1:499156831119:web:872ec2614b79acb09719fa",
      measurementId: "G-7QG5RCK7SZ"
    };
  
    // 2) Init + persist
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
  
    // 3) Gate + lazy-load secure code from Render
    const gate = document.createElement("div");
    gate.style.position = "fixed"; gate.style.inset = 0; gate.style.display = "grid";
    gate.style.placeItems = "center"; gate.style.fontFamily = "system-ui, sans-serif";
    gate.textContent = "Checking login…";
    document.body.appendChild(gate);
  
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not signed in → send to your login page
        window.location.href = "/hungryface/login/";
        return;
      }
      try {
        const token = await user.getIdToken();
        const url = "https://hungryface.onrender.com/assets/crydetector/app_mp.js";
  
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` },
          cache: "no-store"
        });
        if (!res.ok) throw new Error(`Secure script fetch failed: ${res.status} ${await res.text()}`);
  
        // If app_mp_secure.js is an ES module, import it via a Blob URL
        const js    = await res.text();
        const blob  = new Blob([js], { type: "text/javascript" });
        const modURL = URL.createObjectURL(blob);
  
        try {
          const mod = await import(modURL);
          // Optional: call an exported entry if you have one
          if (typeof mod.start === "function") {
            await mod.start({ auth, user, MPTasksAudio: window.MPTasksAudio });
          } else if (typeof mod.default === "function") {
            await mod.default({ auth, user, MPTasksAudio: window.MPTasksAudio });
          }
        } catch {
          // Fallback for non-module scripts
          new Function(js)();
        } finally {
          URL.revokeObjectURL(modURL);
        }
      } catch (err) {
        console.error(err);
        gate.textContent = "Access error. Check console and reload.";
        return;
      }
      // Success → remove gate
      gate.remove();
    });
  </script>
  -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // --- Firebase config (yours) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBUQDNX5ItDQsrReCUdWwwKW4YB7YGjC1I",
    authDomain: "hungryface-53740.firebaseapp.com",
    projectId: "hungryface-53740",
    storageBucket: "hungryface-53740.firebasestorage.app",
    messagingSenderId: "499156831119",
    appId: "1:499156831119:web:872ec2614b79acb09719fa",
    measurementId: "G-7QG5RCK7SZ"
  };

  // --- Init + persistence ---
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence);

  // --- Little overlay while we check auth ---
  const gate = document.createElement("div");
  Object.assign(gate.style, {
    position: "fixed", inset: 0, display: "grid",
    placeItems: "center", fontFamily: "system-ui, sans-serif",
    background: "transparent", zIndex: 9999
  });
  gate.textContent = "Checking login…";
  document.body.appendChild(gate);

  // Helper: show user badge (expects #userBox markup in header)
  function showUserBadge(user) {
    const box   = document.getElementById("userBox");
    const name  = document.getElementById("userName");
    const img   = document.getElementById("userAvatar");
    const init  = document.getElementById("userInitials");

    if (!box || !name || !img || !init) return;

    const friendlyName =
      user.displayName ||
      (user.email ? user.email.split("@")[0] : user.uid.slice(0, 6));

    name.textContent = friendlyName;

    if (user.photoURL) {
      img.src = user.photoURL;
      img.style.display  = "block";
      init.style.display = "none";
    } else {
      const initials = (user.displayName?.match(/\b\w/g) || [friendlyName[0] || "U"])
                        .slice(0, 2).join("").toUpperCase();
      init.textContent   = initials;
      init.style.display = "inline-flex";
      img.style.display  = "none";
    }
    box.style.display = "inline-flex";

    // Sign out
    const btn = document.getElementById("signOut");
    if (btn && !btn._wired) {
      btn._wired = true;
      btn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "/hungryface/login/";
      });
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/hungryface/login/";
      return;
    }

    try {
      // Show who’s signed in
      showUserBadge(user);

      // Fetch secured app code from Render (exact filename!)
      const token = await user.getIdToken();
      const SECURE_URL = "https://hungryface.onrender.com/assets/crydetector/app_mp.js?v=" + Date.now();

      const res = await fetch(SECURE_URL, {
        headers: { Authorization: `Bearer ${token}` },
        cache: "no-store"
      });
      if (!res.ok) throw new Error(`secure fetch ${res.status}: ${await res.text()}`);

      const js = await res.text();

      // Prefer ESM (Blob import), fall back to classic script
      try {
        const blob = new Blob([js], { type: "text/javascript" });
        const modURL = URL.createObjectURL(blob);
        const mod = await import(modURL);
        URL.revokeObjectURL(modURL);

        // If your module exports a starter, call it
        if (typeof mod.start === "function") {
          await mod.start({ auth, user, MPTasksAudio: window.MPTasksAudio });
        } else if (typeof mod.default === "function") {
          await mod.default({ auth, user, MPTasksAudio: window.MPTasksAudio });
        }
      } catch (e) {
        console.warn("[secure] module import failed, executing as script", e);
        new Function(js)();
        // If you build an IIFE that exposes window.CryApp.start, call it:
        if (window.CryApp?.start) {
          await window.CryApp.start({ MPTasksAudio: window.MPTasksAudio });
        }
      }
    } catch (err) {
      console.error("[secure] load error", err);
      gate.textContent = "Access error. See console.";
      return;
    }

    // All good — remove the overlay
    gate.remove();
  });
</script>
  

  
</body>
</html>
