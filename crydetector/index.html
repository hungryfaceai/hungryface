<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Baby Cry Detector (MediaPipe • TFLite)</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Tiny data-URI favicon to avoid /favicon.ico 404 -->
  <link rel="icon" href="data:," />

  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- MediaPipe Tasks Audio (default export) -->
  <script type="module">
    import audio from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-audio@0.10.0";
    // Expose to the non-module app script
    window.MPTasksAudio = audio;
  </script>
</head>
<body>
  <header>
    <h1>Live Baby Cry Detector</h1>
    <p class="sub">MediaPipe (TFLite) • Real-time mic inference</p>
  </header>

  <main>
    <section class="controls">
      <div class="row">
        <button id="btnStart" class="primary">Start</button>
        <button id="btnStop" class="ghost" disabled>Stop</button>
        <span id="status" class="status">Idle</span>
      </div>

      <div class="grid">
        <label>
          <span>SR_TARGET (Hz)</span>
          <input id="SR_TARGET" type="number" min="8000" step="1000" value="16000" />
        </label>

        <label>
          <span>FRAME_LEN_S</span>
          <input id="FRAME_LEN_S" type="number" min="0.1" step="0.01" value="0.96" />
        </label>

        <label>
          <span>HOP_S</span>
          <input id="HOP_S" type="number" min="0.01" step="0.01" value="0.48" />
        </label>

        <label>
          <span>SMOOTH_WIN</span>
          <input id="SMOOTH_WIN" type="number" min="1" step="1" value="5" />
        </label>

        <label>
          <span>THRESH</span>
          <input id="THRESH" type="number" min="0" max="1.5" step="0.01" value="0.15" />
        </label>

        <label>
          <span>PLOT_WINDOW_S</span>
          <input id="PLOT_WINDOW_S" type="number" min="5" step="1" value="60" />
        </label>
      </div>

      <details class="advanced">
        <summary>Advanced</summary>

<label class="wide">
  <span>YAMNet (TFLite) path</span>
  <input id="MODEL_URL" type="url"
         value="https://storage.googleapis.com/mediapipe-models/audio_classifier/yamnet/float32/1/yamnet.tflite" />
</label>

        <label class="wide">
          <span>Include classes (comma-separated)</span>
          <textarea id="INCLUDE_CLASSES" rows="2" spellcheck="false">Baby cry, infant cry</textarea>
        </label>

        <p class="muted small">
          Enter <em>display_name</em> values exactly as in <code>class_map.csv</code> (stored next to this file).
          Separate multiple classes with <strong>semicolons ;</strong> or <strong>new lines</strong>.
          <u>Do not</u> use commas to separate classes; commas can appear inside a single display name
          (e.g., <code>"Narration, monologue"</code>).
        </p>

        <div class="grid-adv">
          <label>
            <span>ON extra (adds to THRESH)</span>
            <input id="ALERT_ON_EXTRA" type="number" step="0.01" value="0.00" />
          </label>
          <label>
            <span>OFF delta (below ON)</span>
            <input id="ALERT_OFF_DELTA" type="number" min="0" step="0.01" value="0.10" />
          </label>
          <label>
            <span>HOLD time (ms)</span>
            <input id="ALERT_HOLD_MS" type="number" min="0" step="100" value="3000" />
          </label>
        </div>
        <p class="muted small">
          The background turns red when the smoothed score crosses the <strong>ON threshold</strong> (= THRESH + ON extra),
          and stays red until it falls below <strong>OFF threshold</strong> (= ON threshold − OFF delta) and the hold time has elapsed.
        </p>
      </details>
    </section>

    <!-- Cry score chart -->
    <section class="plot">
      <canvas id="chart" height="160"></canvas>
      <div class="legend">
        <span class="key raw"></span> cry_score (raw)
        <span class="key sm"></span> smoothed (moving avg)
        <span class="key thr-on"></span> threshold (ON)
        <span class="key thr-off"></span> threshold (OFF)
      </div>
    </section>

    <!-- Power spectrum chart -->
    <section class="plot">
      <canvas id="chartSpectrum" height="160"></canvas>
      <div class="legend">
        <span class="key raw"></span> spectrum (raw)
        <span class="key sm"></span> spectrum (smoothed)
      </div>
      <div class="toggles">
        <label><input type="checkbox" id="showRawSpec" checked> Show raw spectrum</label>
        <label><input type="checkbox" id="showSmSpec" checked> Show smoothed spectrum</label>
      </div>
      <div id="peakReadout" class="peak">Peak: —</div>
    </section>
  </main>

  <footer>
    © 2025 Fishex Ltd. All rights reserved.
  </footer>

  <!-- App code (MediaPipe version) -->
  <!-- <script src="./private_assets/app_mp.js" type="module"></script> THIS IS NOT PROTECTED -->

  <!-- THIS IS: -->
  <!-- Secure loader: fetch protected JS from Render only after Firebase login -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  
    // 1) Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBUQDNX5ItDQsrReCUdWwwKW4YB7YGjC1I",
      authDomain: "hungryface-53740.firebaseapp.com",
      projectId: "hungryface-53740",
      storageBucket: "hungryface-53740.firebasestorage.app",
      messagingSenderId: "499156831119",
      appId: "1:499156831119:web:872ec2614b79acb09719fa",
      measurementId: "G-7QG5RCK7SZ"
    };
  
    // 2) Init + persist
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
  
    // 3) Gate + lazy-load secure code from Render
    const gate = document.createElement("div");
    gate.style.position = "fixed"; gate.style.inset = 0; gate.style.display = "grid";
    gate.style.placeItems = "center"; gate.style.fontFamily = "system-ui, sans-serif";
    gate.textContent = "Checking login…";
    document.body.appendChild(gate);
  
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not signed in → send to your login page
        window.location.href = "/hungryface/login/";
        return;
      }
      try {
        const token = await user.getIdToken();
        const url   = "https://hungryface.onrender.com/assets/crydetector/app_mp.js";
  
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` },
          cache: "no-store"
        });
        if (!res.ok) throw new Error(`Secure script fetch failed: ${res.status} ${await res.text()}`);
  
        // If app_mp_secure.js is an ES module, import it via a Blob URL
        const js    = await res.text();
        const blob  = new Blob([js], { type: "text/javascript" });
        const modURL = URL.createObjectURL(blob);
  
        try {
          const mod = await import(modURL);
          // Optional: call an exported entry if you have one
          if (typeof mod.start === "function") {
            await mod.start({ auth, user, MPTasksAudio: window.MPTasksAudio });
          } else if (typeof mod.default === "function") {
            await mod.default({ auth, user, MPTasksAudio: window.MPTasksAudio });
          }
        } catch {
          // Fallback for non-module scripts
          new Function(js)();
        } finally {
          URL.revokeObjectURL(modURL);
        }
      } catch (err) {
        console.error(err);
        gate.textContent = "Access error. Check console and reload.";
        return;
      }
      // Success → remove gate
      gate.remove();
    });
  </script>

  
</body>
</html>
